 <!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>YouTubeを連続再生してみるサンプル</title>
<link rel="stylesheet" href="/static/css/main.css" type="text/css" media="all">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>
</head>
<body>
<script type="text/javascript">
var video_list = [];
var index = 0;
var init = true;
var api_index = 1;
jQuery(function($) {
    $("#search").click(function(){
        $("#trac_" + index).css("color", "");
        video_list = [];
        index = 0;
        api_index = 1;
        get_list();
    });
    $("#prev").click(function(){
        prev();
    });
    $("#next").click(function(){
        next();
    });
});

function onYouTubePlayerReady(playerId) {
    document.getElementById(playerId).addEventListener("onStateChange", "onytplayerStateChange");
}

function onytplayerStateChange(newState) {
    if (newState == 0) {
        next();
    }
}

function get_list() {
    var query = $("#query").attr("value");
    $.getJSON("http://gdata.youtube.com/feeds/api/videos?callback=?",
        {
            "q": query,
            "alt": "jsonc",
            "v" : 2,
            "max-results":10,
            "format": 5,
            "orderby": "viewCount",
            "start-index": api_index
        },
        function(rs) {
            var query = new RegExp($("#query").attr("value"),"i");
            api_index += 10;
            var rs_list = rs.data.items;

            rs_list = rs_list.sort(function(a, b) {
                return b.favoriteCount - a.favoriteCount;
            });
            for (var i = 0, max = rs_list.length;  i < max; i++) {
                if (rs_list[i].title.match(query)) {
                    video_list.push(rs_list[i]);
                }
            }

            var html = "";
            $.each(video_list, function(i, val){
                html += "<span id=\"trac_" + i + "\">" + this.title + "</span><br />";
            });
            $("#list").html(html);

            if ( video_list.length == 0 ) {
                return;
            }

            if (init) {
                swfobject.embedSWF("http://www.youtube.com/v/" + video_list[index].id + "?enablejsapi=1&autoplay=1&playerapiid=player",
                                  "video", "854", "480", "8", null, null, { allowScriptAccess: "always" }, { id: "player" });
                init = false;
            } else {
                $("#info").html(video_list[index].title);
                $("#trac_" + index).css("color", "red");
                document.getElementById("player").loadVideoById(video_list[index].id);
            }
            _highlight();
       }
    );
}

function next() {
    if ( index >= video_list.length ) {
        return;
    }
    $("#trac_" + index).css("color", "black");
    document.getElementById("player").loadVideoById(video_list[++index].id);
    _highlight();
    if ( video_list.length < (index + 3) ) {
        get_list();
    }
}
function prev() {
    if ( index < 1 ) {
        return;
    }
    $("#trac_" + index).css("color", "black");
    document.getElementById("player").loadVideoById(video_list[--index].id);
    _highlight();
}

function _highlight() {
    $("#info").html(video_list[index].title);
    $("#trac_" + index).css("color", "red");
}
</script>
<h1>YouTubeを連続再生してみるサンプル</h1>
<div>
<input type="text" id="query" value=""/>
<input type="button" id="search" value="search" />
|
<input type="button"  id="prev" value="Prev" />
<input type="button"  id="next" value="Next" />
&nbsp;
<span id="info"></span>
</div>
<div id="video"></div>
<div id="list"></div>
</body>
</html>
